<!doctype html>
<html lang="en" data-bs-theme="auto">
  <head><script src="../assets/js/color-modes.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU" type="text/javascript"></script>
    <meta charset="utf-8">
    <title>Карта диагностик</title>
    <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/headers/">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">

<link href="{{ url_for('static', filename='assets/dist/css/bootstrap.min.css') }}" rel="stylesheet">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
      
      .main-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0;
        margin-top: 10px;
      }
    </style>
    <!-- Custom styles for this template -->
    <link href="{{ url_for('static', filename='headers.css') }}" rel="stylesheet">
  </head>
  <body>
    <main>
        <div class="container">
            <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">    <a href="{{ url_for('index') }}" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none">
                <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"/></svg>
                <span class="fs-4">PLI Service</span>
            </a>    <ul class="nav nav-pills">
                {% if session['role'] == 'User' or session['role'] == 'Admin'%}
                  <li class="nav-item"><a href="{{ url_for('add_diagnostic', diagnostic_id=0) }}" class="nav-link active" aria-current="page">Добавить</a></li>
                {% endif %}
                <li class="nav-item"><a href="{{ url_for('view_diagnostics') }}" class="nav-link">Диагностики</a></li>
                <li class="nav-item"><a href="{{ url_for('map_page') }}" class="nav-link">Карта</a></li>
                <li class="nav-item"><a href="#" class="nav-link">Настройки</a></li>
                <li class="nav-item"><a href="#" class="nav-link">О приложении</a></li>
                <li class="nav-item"><a href="{{ url_for('admin_panel') }}" class="nav-link">{% if session['role'] == 'Admin' %}Панель администратора{% else %}Аккаунт{% endif %}</a></li>
            </ul>
            </header>
        </div>
        <div class="main-content">
          <div id="map" style="width: 80%; height: 600px"></div>
            <script type="text/javascript">
                ymaps.ready(init);
                    function init() {
                        // Создание объекта карты с центром на Иркутске
                        var myMap = new ymaps.Map('map', {
                                center: [52.27,104.31],
                                zoom: 13
                            }),
                            
                            // Передаем данные из Flask в json и записываем в переменную
                            diagnostics = {{ diagnostics|tojson|safe }};
                            {% for diagnostic in diagnostics %}
                                // В цикле генерируем маркеры на карте
                                diagnostics.forEach(function(diagnostic) {
                                    var id = diagnostic.id;
                                    var title = diagnostic.short_title;
                                    var diagnostic_type = diagnostic.diagnostic_type;
                                    var coordinates = diagnostic.coordinates;
                                    var lst_coordinates = coordinates.split(',').map(Number);
                                    
                                    // Меняем цвет маркера, в зависимости от типа диагностики
                                    switch (diagnostic_type) {
                                        case 'Без повреждений':
                                            var ico_link = '/static/assets/mark1.png';
                                            break;
                                        case 'Повреждение':
                                            var ico_link = '/static/assets/mark2.png';
                                            break;
                                        case 'Найден колодец':
                                            var ico_link = '/static/assets/mark3.png';
                                            break;
                                        case 'Приемка':
                                            var ico_link = '/static/assets/mark4.png';
                                            break;
                                        default:
                                            var ico_link = '/static/assets/mark1.png';
                                    }
                                    
                                    // Создание маркера с ссылкой в названии
                                    var myPlacemark = new ymaps.Placemark(lst_coordinates, {
                                        hintContent: title,
                                        balloonContent: '<strong><a href="{{ url_for('diagnostic_page', diagnostic_id=diagnostic['id']) }}">' + title + '</a></strong>'
                                    }, {
                                        // Опции.
                                        // Необходимо указать данный тип макета.
                                        iconLayout: 'default#image',
                                        // Своё изображение иконки метки.
                                        iconImageHref: ico_link,
                                        // Размеры метки.
                                        iconImageSize: [18, 18],
                                        // Смещение левого верхнего угла иконки относительно
                                        // её "ножки" (точки привязки).
                                        iconImageOffset: [-10, -10]
                                    });
                                
                                    myMap.geoObjects.add(myPlacemark);
                                });
                            {% endfor %}

                            var areas = {{ areas|tojson|safe }};

                            // Добавление многоугольников на карту
                            areas.forEach(function(area) {
                                var polygon = new ymaps.GeoObject({
                                    geometry: {
                                        type: "Polygon",
                                        coordinates: [area.coordinates],
                                        fillRule: "nonZero"
                                    },
                                    properties: {
                                        // hintContent: area.name
                                    }
                                }, {
                                    fillColor: area.color + "40",
                                    strokeColor: area.color,
                                    strokeWidth: 3,
                                    opacity: 0.5
                                });

                                myMap.geoObjects.add(polygon);
                            });
                    }
            </script>
        </div>
      </main>
      <script src="{{ url_for('static', filename='assets/dist/js/bootstrap.bundle.min.js') }}"></script>
    </body>
</html>
